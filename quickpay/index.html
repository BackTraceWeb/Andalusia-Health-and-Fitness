<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QuickPay Portal — Andalusia Health & Fitness</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #000;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .box {
      background: #111;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 0 30px rgba(255, 0, 80, 0.4);
      max-width: 420px;
      width: 100%;
      text-align: center;
    }
    h1 {
      color: #ff0066;
      margin-bottom: 25px;
    }
    input[type="text"] {
      width: 80%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      margin: 5px 0;
      text-align: center;
    }
    button {
      width: 85%;
      margin-top: 15px;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1rem;
    }
    button#findBtn {
      background: #ff0066;
      color: #fff;
    }
    button#findBtn:disabled {
      background: #555;
      cursor: not-allowed;
    }
    button#payBtn {
      background: #333;
      color: #ccc;
    }
    button#payBtn.active {
      background: #a72852;
      color: #fff;
    }
    .status {
      margin-top: 20px;
      font-size: 0.95rem;
    }
    .status.ok { color: #e600a1; }
    .status.error { color: #ff1744; }
    .status.info { color: #ffffff; }
    footer {
      margin-top: 40px;
      font-size: 0.75rem;
      color: #888;
    }
    footer a { color: #ff0066; text-decoration: none; }
  </style>
</head>
<body>
  <div class="box">
    <h1>QuickPay Portal</h1>

    <p>Enter your first and last name:</p>
    <input type="text" id="firstName" placeholder="First name">
    <input type="text" id="lastName" placeholder="Last name">

    <button id="findBtn" onclick="lookup()">Find Member</button>
    <div id="status" class="status"></div>

    <button id="payBtn" disabled>Pay Securely</button>

    <input type="hidden" id="memberId">
    <input type="hidden" id="invoiceId">

    <footer>
      <a href="#Legal/terms">Terms & Conditions</a> | <a href="#Legal/privacy">Privacy Policy</a>
    </footer>
  </div>

  <script>
    const elFirst = document.getElementById('firstName');
    const elLast = document.getElementById('lastName');
    const elFindBtn = document.getElementById('findBtn');
    const elPayBtn = document.getElementById('payBtn');
    const elStatus = document.getElementById('status');
    const elMemberId = document.getElementById('memberId');
    const elInvoiceId = document.getElementById('invoiceId');

    async function lookup() {
      const first = elFirst.value.trim();
      const last = elLast.value.trim();

      if (!first || !last) {
        setStatus('Please enter both first and last name.', 'error');
        return;
      }

      setStatus('Looking up member...', 'info');
      elFindBtn.disabled = true;
      elPayBtn.disabled = true;

      try {
        const search = encodeURIComponent(`${first} ${last}`);
        const res = await fetch(`/api/member-detail.php?search=${search}`);
        const data = await res.json();

        if (!data.ok) {
          setStatus('Member not found or inactive.', 'error');
          elFindBtn.disabled = false;
          return;
        }

        const m = data.member;
        if (data.status === 'due' && data.invoice) {
          const amount = `$${(data.invoice.amount_cents / 100).toFixed(2)}`;
          setStatus(`
            <strong>${m.first_name} ${m.last_name}</strong> found.<br>
            Amount due: <strong>${amount}</strong><br>
            <small>Period ${data.invoice.period_start ?? ''} – ${data.invoice.period_end ?? ''}</small>
          `, 'ok');

          elMemberId.value = m.id;
          elInvoiceId.value = data.invoice.id;
          elPayBtn.disabled = false;
          elPayBtn.classList.add('active');
        } else {
          setStatus(`<strong>${m.first_name} ${m.last_name}</strong> found.<br>No payment is due right now.`, 'ok');
          elPayBtn.disabled = true;
          elPayBtn.classList.remove('active');
        }

      } catch (err) {
        console.error(err);
        setStatus('Error contacting server.', 'error');
      } finally {
        elFindBtn.disabled = false;
      }
    }

    elPayBtn.onclick = function() {
      const memberId = elMemberId.value;
      const invoiceId = elInvoiceId.value;

      if (!memberId || !invoiceId) {
        alert('No member or invoice selected.');
        return;
      }

      // Redirect directly into hosted Authorize.Net payment
      const url = `/api/payments/authorize-hosted.php?memberId=${encodeURIComponent(memberId)}&invoiceId=${encodeURIComponent(invoiceId)}`;
      window.location.href = url;
    };

    function setStatus(msg, cls) {
      elStatus.innerHTML = msg;
      elStatus.className = 'status ' + cls;
    }
  </script>
</body>
</html>
